---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ScrollProgress from '../components/ScrollProgress.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

// Fetch YouTube metadata using oEmbed API
const talks = [
	{ url: 'https://www.youtube.com/watch?v=PLOtpbdqDxY' },
	{ url: 'https://www.youtube.com/watch?v=FGxjqxXucsM' },
	{ url: 'https://www.youtube.com/watch?v=sxxcDNbvCNE' },
	{ url: 'https://www.youtube.com/watch?v=uwEGj_OH1Xw' },
	{ url: 'https://www.youtube.com/watch?v=1NkrY9FWsKc' },
];

async function fetchVideoData(url: string) {
	try {
		const response = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
		if (!response.ok) return null;
		const data = await response.json();
		// Extract video ID from URL
		const videoId = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([^&\n?#]+)/)?.[1];
		return {
			...data,
			videoId,
			thumbnailUrl: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`
		};
	} catch (error) {
		console.error('Failed to fetch video data:', error);
		return null;
	}
}

const talkData = await Promise.all(talks.map(talk => fetchVideoData(talk.url)));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main {
				display: grid;
				grid-template-columns: 1fr 2fr;
				gap: 2rem;
				padding: 2rem 1rem;
				position: relative;
				z-index: 2;
			}

			.sidebar {
				grid-column: 1;
				min-width: 200px;
				padding: 2rem;
				border-radius: 0px;
				box-shadow: var(--box-shadow-light);
				background: var(--primary);
				border: 4px solid var(--border);
				position: sticky;
				top: 2rem;
				height: fit-content;
				transition: var(--transition);
				overflow: hidden;
				z-index: 3;
				transform: rotate(-1deg);
			}

			body.dark-mode .sidebar {
				box-shadow: var(--box-shadow-dark);
			}

			.sidebar:hover {
				transform: rotate(0deg) translate(-2px, -2px);
				box-shadow: 10px 10px 0px 0px var(--border);
			}

			.sidebar h2 {
				font-size: 1.6rem;
				margin-bottom: 1.5rem;
				color: var(--border);
				text-align: center;
				text-transform: uppercase;
				letter-spacing: 1px;
				font-family: var(--font-heading);
				font-weight: 900;
			}

			.sidebar h2::before {
				content: "◐";
				display: block;
				font-size: 2rem;
				margin-bottom: 0.5rem;
			}

			.profile-img {
				width: 150px;
				height: 150px;
				border-radius: 0px;
				object-fit: cover;
				display: block;
				margin: 0 auto 1.5rem;
				box-shadow: 6px 6px 0 var(--border);
				transition: transform 0.2s ease;
				border: 4px solid var(--border);
			}

			.profile-img:hover {
				transform: translate(-2px, -2px) rotate(2deg);
				box-shadow: 8px 8px 0 var(--border);
			}

			.sidebar p {
				font-size: 0.95rem;
				margin: 0.6rem 0;
				text-align: center;
				font-weight: 700;
				color: var(--border);
				font-family: var(--font-heading);
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.social-links {
				display: flex;
				justify-content: center;
				gap: 1rem;
				margin-top: 1.5rem;
			}

			.social-links a {
				color: var(--primary);
				text-decoration: none;
				transition: var(--transition);
				display: flex;
				align-items: center;
				justify-content: center;
				width: 42px;
				height: 42px;
				border-radius: 0px;
				background: var(--border);
				border: 3px solid var(--border);
				box-shadow: 3px 3px 0px 0px var(--border);
			}

			.social-links a:hover {
				background: var(--accent-2);
				color: var(--border);
				transform: translate(-2px, -2px);
				box-shadow: 5px 5px 0px 0px var(--border);
			}

			.social-links a:active {
				transform: translate(1px, 1px);
				box-shadow: 2px 2px 0px 0px var(--border);
			}

			.content {
				grid-column: 2;
				min-width: 300px;
				display: grid;
				grid-template-columns: 1fr;
				gap: 1.5rem;
			}

			.hero {
				position: relative;
				background: var(--primary);
				color: var(--border);
				padding: 4rem 2rem;
				border-radius: 0px;
				margin-bottom: 2rem;
				text-align: center;
				overflow: hidden;
				box-shadow: var(--box-shadow-light);
				border: 4px solid var(--border);
				z-index: 1;
			}

			body.dark-mode .hero {
				box-shadow: var(--box-shadow-dark);
			}

			.hero::after {
				content: "◒";
				position: absolute;
				right: 2rem;
				bottom: 1rem;
				font-size: 6rem;
				color: var(--accent-2);
				opacity: 0.3;
				transform: rotate(15deg);
			}

			.hero > * {
				position: relative;
				z-index: 1;
			}

			.hero h1 {
				font-size: clamp(2.5rem, 5vw, 3.5rem);
				margin-bottom: 1rem;
				letter-spacing: -2px;
				color: var(--border);
				font-family: var(--font-heading);
				font-weight: 900;
			}

			.hero p {
				font-size: clamp(1.1rem, 2vw, 1.3rem);
				margin-bottom: 2rem;
				font-weight: 600;
				color: var(--border);
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
			}

			.hero a {
				background: var(--border);
				border: 3px solid var(--border);
				color: var(--primary);
				padding: 1rem 2.5rem;
				border-radius: 0px;
				font-weight: 900;
				font-family: var(--font-heading);
				transition: var(--transition);
				box-shadow: 6px 6px 0px 0px var(--border);
				text-transform: uppercase;
				letter-spacing: 1px;
				display: inline-block;
			}

			.hero a:hover {
				background: var(--accent-2);
				border-color: var(--border);
				color: var(--border);
				transform: translate(-2px, -2px);
				box-shadow: 8px 8px 0px 0px var(--border);
				text-decoration: none;
			}

			.hero a:active {
				transform: translate(1px, 1px);
				box-shadow: 4px 4px 0px 0px var(--border);
			}

			section {
				margin-bottom: 2rem;
				background: var(--card-bg);
				border: 3px solid var(--border);
				padding: 2.5rem;
				border-radius: 0px;
				box-shadow: var(--box-shadow-light);
				transition: var(--transition);
				position: relative;
				overflow: hidden;
				z-index: 2;
			}

			body.dark-mode section {
				box-shadow: var(--box-shadow-dark);
			}

			section:hover {
				transform: translate(-2px, -2px) rotate(0.5deg);
				box-shadow: 10px 10px 0px 0px var(--border);
				z-index: 5;
			}

			section h2 {
				font-size: clamp(1.5rem, 3vw, 2rem);
				margin-bottom: 1.5rem;
				color: var(--text-primary);
				position: relative;
				display: inline-block;
				letter-spacing: 0.5px;
				font-family: var(--font-heading);
				font-weight: 900;
				text-transform: uppercase;
				background: var(--primary);
				padding: 0.5rem 1rem;
				border: 3px solid var(--border);
				box-shadow: 4px 4px 0px 0px var(--border);
				color: var(--border);
			}

	/* Highlights Section */
		.highlights .highlight-card {
			margin-top: 1rem;
			padding: 2rem;
			background: var(--card-bg);
			border: 4px solid var(--border);
			position: relative;
			transform: rotate(-0.5deg);
		}

		.highlights .highlight-card:hover {
			transform: rotate(0deg);
		}

		.highlight-badge {
			display: inline-block;
			background: var(--accent-1);
			color: var(--bg);
			padding: 0.4rem 0.8rem;
			font-size: 0.75rem;
			font-weight: 900;
			font-family: var(--font-heading);
			text-transform: uppercase;
			letter-spacing: 1px;
			border: 3px solid var(--border);
			margin-bottom: 1rem;
			box-shadow: 3px 3px 0px 0px var(--border);
		}

		.highlight-card h3 {
			font-size: clamp(1.3rem, 2.5vw, 1.8rem);
			font-family: var(--font-heading);
			font-weight: 900;
			text-transform: uppercase;
			margin-bottom: 1rem;
			color: var(--text-primary);
		}

		.highlight-card p {
			margin-bottom: 1rem;
			line-height: 1.7;
			color: var(--text-primary);
		}

		.highlight-card p strong {
			color: var(--accent-1);
			font-weight: 700;
		}

		.highlight-link {
			display: inline-block;
			margin-top: 1rem;
			padding: 0.8rem 1.5rem;
			background: var(--primary);
			color: var(--border);
			text-decoration: none;
			font-weight: 700;
			font-family: var(--font-heading);
			text-transform: uppercase;
			font-size: 0.9rem;
			border: 3px solid var(--border);
			box-shadow: 4px 4px 0px 0px var(--border);
			transition: var(--transition);
		}

		.highlight-link:hover {
			transform: translate(-2px, -2px);
			box-shadow: 6px 6px 0px 0px var(--border);
			background: var(--accent-2);
		}

		.highlight-link:active {
			transform: translate(1px, 1px);
			box-shadow: 2px 2px 0px 0px var(--border);
		}

		ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		ul li {
			padding: 0.8rem 1.2rem;
			line-height: 1.6;
			border-left: 4px solid var(--primary);
			margin-bottom: 0.6rem;
			transition: var(--transition);
			background: transparent;
		}

		ul li:hover {
			background: var(--card-bg);
			border-left-color: var(--accent-1);
			padding-left: 1.5rem;
		}

		ul li a {
			color: var(--text-primary);
			transition: var(--transition);
			font-weight: 700;
			text-decoration: none;
		}

	ul li a:hover {
		color: var(--accent-1);
		text-decoration: underline;
		text-decoration-thickness: 2px;
	}

	/* Talk Cards */
	.talks-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
		gap: 1rem;
		margin-top: 1rem;
	}

	.talk-card {
		display: block;
		background: var(--card-bg);
		border: 3px solid var(--border);
		text-decoration: none;
		transition: var(--transition);
		overflow: hidden;
		box-shadow: 3px 3px 0px 0px var(--border);
	}

	.talk-card:hover {
		transform: translate(-2px, -2px);
		box-shadow: 5px 5px 0px 0px var(--border);
	}

	.talk-thumbnail {
		width: 100%;
		height: 120px;
		object-fit: cover;
		display: block;
		border-bottom: 2px solid var(--border);
	}

	.talk-info {
		padding: 0.75rem;
	}

	.talk-info h3 {
		font-size: 0.9rem;
		font-weight: 700;
		color: var(--text-primary);
		margin: 0 0 0.35rem 0;
		line-height: 1.3;
		font-family: var(--font-heading);
	}

	.talk-author {
		font-size: 0.75rem;
		color: var(--accent-1);
		margin: 0;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

		@media (max-width: 900px) {
				main {
					grid-template-columns: 1fr;
					padding: 1.5rem 1rem;
				}

				.sidebar {
					position: relative;
					top: 0;
					margin-bottom: 2rem;
				}

				.hero {
					padding: 2.5rem 1.5rem;
				}
			}

			@media (max-width: 768px) {
				/* Add padding to bottom to account for fixed bottom navbar */
				body {
					padding-bottom: 80px; /* Height of the bottom navbar + some spacing */
				}

				main {
					padding: 1rem 1rem 2rem;
				}

				.sidebar {
					margin-bottom: 1.5rem;
				}
			}

			@media (max-width: 500px) {
				body {
					padding-bottom: 70px;
				}

				main {
					padding: 0.5rem 0.5rem 1.5rem;
				}

				.hero h1 {
					font-size: 2rem;
				}

				.hero p {
					font-size: 1rem;
				}

				section {
					padding: 1.5rem;
				}
			}

			/* Canvas background animation */
			#background-canvas {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 0;
				opacity: 0.05;
				pointer-events: none;
			}

			body.dark-mode #background-canvas {
				opacity: 0.1;
			}
		</style>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
		<script src="/js/three.js" is:inline></script>
		<script>
			// Three.js background animation
			document.addEventListener('DOMContentLoaded', () => {
				const body = document.body;
				
				const initCanvas = () => {
					const scene = new THREE.Scene();
					const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
					const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
					renderer.setSize(window.innerWidth, window.innerHeight);
					renderer.setPixelRatio(1); // Lower resolution for retro effect
					document.getElementById('background-canvas').appendChild(renderer.domElement);
					
					// Create a retro grid
					const gridSize = 50;
					const gridDivisions = 20;
					const gridHelper = new THREE.GridHelper(gridSize, gridDivisions, 0x00b7b7, 0x00b7b7);
					gridHelper.rotation.x = Math.PI / 2;
					gridHelper.position.z = -10;
					scene.add(gridHelper);
					
					// Add faint lines in the background
					const particlesCount = 1000;
					const positions = new Float32Array(particlesCount * 3);
					const sizes = new Float32Array(particlesCount);
					
					for (let i = 0; i < particlesCount; i++) {
						const i3 = i * 3;
						positions[i3] = (Math.random() - 0.5) * 100;
						positions[i3 + 1] = (Math.random() - 0.5) * 100;
						positions[i3 + 2] = (Math.random() - 0.5) * 50 - 20;
						sizes[i] = Math.random() * 0.5 + 0.2;
					}
					
					const geometry = new THREE.BufferGeometry();
					geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
					geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
					
					const material = new THREE.PointsMaterial({
						color: body.classList.contains('dark-mode') ? 0x00b7b7 : 0x008080,
						size: 0.5,
						transparent: true,
						opacity: 0.3,
						sizeAttenuation: true
					});
					
					const particles = new THREE.Points(geometry, material);
					scene.add(particles);
					
					camera.position.z = 30;
					
					const animate = () => {
						requestAnimationFrame(animate);
						
						// Slow rotation of grid
						gridHelper.rotation.z += 0.001;
						
						// Slow movement of particles
						const positions = particles.geometry.attributes.position.array;
						for (let i = 0; i < particlesCount; i++) {
							const i3 = i * 3;
							positions[i3 + 2] += 0.02; // Slow movement towards camera
							if (positions[i3 + 2] > 30) {
								positions[i3 + 2] = -30;
							}
						}
						particles.geometry.attributes.position.needsUpdate = true;
						
						renderer.render(scene, camera);
					};
					
					animate();
					
					// Handle resize
					window.addEventListener('resize', () => {
						camera.aspect = window.innerWidth / window.innerHeight;
						camera.updateProjectionMatrix();
						renderer.setSize(window.innerWidth, window.innerHeight);
					});
					
				};
				
				// Initialize canvas only if WebGL is supported
				if (window.THREE && window.THREE.WebGLRenderer) {
					initCanvas();
				}
			});
		</script>
	</head>
	<body>
		<canvas id="background-canvas"></canvas>
		<ScrollProgress />
		<Header />
		<main>
			<div class="sidebar">
				<h2>Kapil Reddy</h2>
				<img src="/images/profile.jpeg" alt="Kapil Reddy" class="profile-img" />
				<p>Software Generalist</p>
				<p>Builder & Storyteller</p>
				<div class="social-links">
					<a href="https://github.com/kapilreddy" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
						<svg width="24" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
							<title>GitHub</title>
							<path
								fill="currentColor"
								d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"
							></path>
						</svg>
					</a>
					<a href="https://twitter.com/kapilreddy" target="_blank" rel="noopener noreferrer" aria-label="Twitter/X">
						<svg width="24" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
							<title>X</title>
							<path
								fill="currentColor"
								d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"
							></path>
						</svg>
					</a>
				</div>
			</div>

			<div class="content">
				<div class="hero">
					<h1>Hello! I am Kapil.</h1>
					<p>I use this space to write my thoughts and musings about tech, systems and management.</p>
					<a href="/about">More About Me</a>
				</div>

				<section class="highlights">
					<h2>Recent Highlights</h2>
					<div class="highlight-card">
						<div class="highlight-badge">MERGED PR</div>
						<h3>Added Python 3.14 Support for DSPy</h3>
						<p>We use <strong>DSPy</strong> (Stanford NLP's LLM framework, 30k+ stars) extensively at Unravel. I contributed Python 3.14 support to address breaking changes in annotation lookups, ensuring we could use the newest Python version.</p>
						<a href="https://github.com/stanfordnlp/dspy/issues/9038" target="_blank" rel="noopener noreferrer" class="highlight-link">
							View on GitHub →
						</a>
					</div>
				</section>

				<section>
					<h2>Things I Obsess Over</h2>
					<ul>
						<li>AI agents</li>
                                                <li>Clojure and Functional Programming</li>
						<li>Search systems</li>
						<li>Real time messageing</li>
						<li>Migrations of any flavours</li>
						<li>Leading technical platform teams</li>
						<li>Computer graphics and creative coding</li>
					</ul>
				</section>

				<section>
					<h2>Some Projects</h2>
					<ul>
                                                <li>
							<a href="https://github.com/unravel/litellm-clj">Litellm-clj</a> - An unified Clojure API for all LLMs
						</li>
                                                <li>
							<a href="https://github.com/unravel/litellm-clj">DSCloj</a> - Declarative prompt engineering in Clojure
						</li>
						<li><a href="https://unrealcards.net">Unrealcards</a> - A multiplayer card game written in Clojurescript</li>
						<li><a href="https://github.com/kapilreddy/senju">Senju</a> - An ESP32 and Rust based humidity sensing setup</li>

						<li>
							<a href="https://github.com/kapilreddy/instructor-clj">Instructor-clj</a> - A Clojure implementation of
							Instructor library. Get structured output and validations from LLMs.
						</li>
			</ul>
		</section>

	<section class="talks">
		<h2>Talks</h2>
		<div class="talks-grid">
			{talkData.map((talk, index) => talk && (
				<a href={talks[index].url} target="_blank" rel="noopener noreferrer" class="talk-card">
					<img src={talk.thumbnailUrl} alt={talk.title} class="talk-thumbnail" />
					<div class="talk-info">
						<h3>{talk.title}</h3>
						<p class="talk-author">{talk.author_name}</p>
					</div>
				</a>
			))}
		</div>
	</section>
	</div>
		</main>
		<Footer />
	</body>
</html>
